# 4. Canary Deployment \(JJ\)

Canary 배포는 새로운 버전을 배포할때 전체 서비스에 영향을 최소화 하면서 무중단 서비스를 운영하는 배포 기술입니다. 기본적인 개념은 새로운 버전의 소프트웨어를 배포하고 트래픽 전송량을 조금씩 올리면서 위험을 조기 발견하여 안전하게 배포하는 것입니다. 트래픽을 올리면서 새로운 버전에 대한 사용자들의 반응을 살필수 있고, 트래픽 전송량을 높이는 중간에 문제가 발생하면 바로 이전 버전(검증된 버전)으로 롤백 할 수 있습니다.

> canary 라는 이름은 광부들이 광산에 카나리아와 함께 진입하는데에서 유래했습니다. 광산에서 유독가스가 누출되면 카나리아가 먼저 죽기 때문에 광부들은 위험에 미리 대처할 수 있습니다. canary 배포 방식은는 전체 인프라 또는 서비스에 영향을 미치기전에 잠재적인 문제를 조기 발견 할 수 있는 기술입니다. 

무엇보다 Canary 배포의 가장 큰 장점은 운영환경에 배포할 수 있다는 것입니다. 테스트 환경을 구축할때 늘 운영환경과 동일한 환경을 갖추려고 노력합니다. 그것은 VM, container 는 물론이며 Data 또한 마찬가지 입니다. (그래서 Stage 환경, Stage Database 등 을 따로 구축하고 운영하기도 합니다.) 그러나 Canary 배포 방식은 운영환경에서 추가로 배포한 뒤에 트래픽 제어만을 활용하기 때문에 Canary 방식의 배포를 통해 테스트가 끝난 시점은 곧 배포 완료 시점과 동일합니다.

Canary 배포에 대한 자세한 내용은 [여기](https://martinfowler.com/bliki/CanaryRelease.html) 에서 확인 할 수 있습니다.

> Martin Fowler 가 이 방식을 소개한 책입니다.
Continuous Delivery: Reliable Software Releases through Build, Test, and Deployment Automation (Addison-Wesley Signature Series (Fowler))

## Canary deployment 구현

istio 는 트래픽을 제어하는 기술이기 때문에 canary 배포를 쉽게 지원할 수 있습니다. 실제 예를 통해 살펴보겠습니다.

### Kubernetes 기능만 사용한 canary deployment

쿠버네티스의 기본 기능만으로 이미 canary 배포를 구현할 수 있습니다. 쿠버네티스에서 소개하는 방식은 deployment spec 에 labels 를 구분해서 2개의 deployment 를 배포하고 1개의 service 에 붙이는 방법입니다.
예를들어 

```yaml
     name: frontend
     replicas: 3
     ...
     labels:
        app: guestbook
        tier: frontend
        track: stable
     ...
     image: gb-frontend:v3
```

```yaml
     name: frontend-canary
     replicas: 1
     ...
     labels:
        app: guestbook
        tier: frontend
        track: canary
     ...
     image: gb-frontend:v4
```

### Istio 를 사용한 canary deployment
